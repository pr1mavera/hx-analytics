(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{288:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"模式切换机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模式切换机制"}},[t._v("#")]),t._v(" 模式切换机制")]),t._v(" "),a("ul",[a("li",[t._v("sdk初始化之后，会根据当前环境（是否在埋点配置用iframe内）进入对应模式")]),t._v(" "),a("li",[t._v("可在 "),a("code",[t._v("HXAnalytics")]),t._v(" 类直接通过 "),a("code",[t._v("this.mode = 'report';")]),t._v(" 的方式切换模式，")]),t._v(" "),a("li",[t._v("每个模式都有自己的基本生命周期（onEnter、onExit），会在模式切换的时候自动触发（通过重写 "),a("code",[t._v("this.mode")]),t._v(" 的 "),a("code",[t._v("get / set")]),t._v("）")])]),t._v(" "),a("h2",{attrs:{id:"埋点命中规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#埋点命中规则"}},[t._v("#")]),t._v(" 埋点命中规则")]),t._v(" "),a("p",[t._v("sdk在客户端记录的是全量行为日志，势必存在业务人员不关心的无效数据，需要在入库前根据埋点配置信息进行数据清洗操作")]),t._v(" "),a("p",[t._v("客户行为数据（type: 2 且 isSysEvt: N）需要在清洗阶段会根据以下字段进行过滤：")]),t._v(" "),a("ul",[a("li",[t._v("sysId - 系统唯一标识")]),t._v(" "),a("li",[t._v("pageId - 页面唯一标识")]),t._v(" "),a("li",[t._v("funcId - 埋点唯一标识")])]),t._v(" "),a("h4",{attrs:{id:"sysid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sysid"}},[t._v("#")]),t._v(" sysId")]),t._v(" "),a("p",[t._v("接入sdk时每个提供获取的唯一标识")]),t._v(" "),a("h4",{attrs:{id:"pageid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pageid"}},[t._v("#")]),t._v(" pageId")]),t._v(" "),a("p",[t._v("通过 "),a("code",[t._v("window.location.pathname")]),t._v(" 和 "),a("code",[t._v("window.location.hash")]),t._v(" 除去 "),a("code",[t._v("query")]),t._v(" 拼接得到")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getPageId")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" pathname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hash "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("location"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" pathname "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" _"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("first")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("split")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'?'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"funcid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#funcid"}},[t._v("#")]),t._v(" funcId")]),t._v(" "),a("p",[t._v("根据 "),a("a",{attrs:{href:"https://github.com/rowthan/whats-element",target:"_blank",rel:"noopener noreferrer"}},[t._v("whats-element"),a("OutboundLink")],1),t._v(" 生成页面元素唯一标识，同时拼接上 sysId 、 pageId"),a("br"),t._v("\n在配置阶段及上报阶段统一使用该规则命中埋点，大致组成如下")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("getElemPid")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("sysId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pageId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" wid "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("whatsElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUniqueId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n         * wid: 元素指纹\n         * type: 根据指纹可以唯一获取到元素的API\n         * sysId: sysId\n         * pageId: pageId\n         * \n         * 统一使用 '!' 连接\n         */")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("wid"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("sysId"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("pageId"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"数据报的组装及中间件机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据报的组装及中间件机制"}},[t._v("#")]),t._v(" 数据报的组装及中间件机制")]),t._v(" "),a("p",[t._v("数据上报 "),a("code",[t._v("msg")]),t._v(" "),a("em",[a("strong",[t._v("模板字段")])]),t._v(" :")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("reportType1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'batchId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           访问流水号 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'appId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*             应用Id */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'appName'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           应用名称 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sysId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*             系统Id */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sysName'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           系统名称 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'origin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*            客户来源 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'openId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*            openId */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'clientType'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*        客户端设备型号 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sysVersion'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*        客户端系统版本 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ip'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                客户端IP */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'userNetWork'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*       客户端网络状态 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'createTime'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*         服务端事件时间 */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nreportType2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'batchId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           访问流水号 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sysId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*             系统Id */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pageId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*            页面Path */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pageName'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*          页面名称 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pageUrl'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           完整页面地址 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'funcId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*            埋点Id */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'funcName'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*          埋点名称 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'funcIntention'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*     埋点意向 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'preFuncId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*         上一个事件埋点Id */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'eventId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           事件Id（原生事件为事件的 eventType，自定义事件为自定义事件id，在配置界面设置） */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'eventName'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*         事件名称 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'eventType'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*         事件类型 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'eventTime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*         客户端事件时间 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'createTime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*        服务端事件时间 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pageDwellTime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*     页面停留时长 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'enterTime'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*         客户端页面进入时间 */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'leaveTime'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*          客户端页面离开时间 */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("组装规则为：")]),t._v(" "),a("ol",[a("li",[a("code",[t._v("key")]),t._v("="),a("code",[t._v("value")])]),t._v(" "),a("li",[t._v("使用 "),a("code",[t._v("|")]),t._v(" 分隔")]),t._v(" "),a("li",[t._v("若 "),a("code",[t._v("value")]),t._v(" 没有，则使用 "),a("code",[t._v("${key}")]),t._v(" 代替")])]),t._v(" "),a("p",[t._v("例如： "),a("code",[t._v("type=1|batchId=xxxxxxx|appId=${appId}...")])]),t._v(" "),a("h3",{attrs:{id:"组装方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#组装方式"}},[t._v("#")]),t._v(" 组装方式")]),t._v(" "),a("h4",{attrs:{id:"流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程"}},[t._v("#")]),t._v(" 流程")]),t._v(" "),a("ol",[a("li",[t._v("宿主环境触发事件，调用 "),a("code",[t._v("Report.onTrigger")])]),t._v(" "),a("li",[t._v("经过各事件中间件组装特定参数，生成 "),a("code",[t._v("extendsData")])]),t._v(" "),a("li",[t._v("组装 "),a("code",[t._v("reqData")]),t._v(" ，其中 "),a("code",[t._v("msg")]),t._v(" 字段依靠 "),a("em",[a("strong",[t._v("模板字段")])]),t._v(" 匹配 "),a("code",[t._v("extendsData")]),t._v(" 、 "),a("code",[t._v("AppConfig")]),t._v(" 参数，统一组装")]),t._v(" "),a("li",[t._v("将 "),a("code",[t._v("reqData")]),t._v(" 推送至消息队列")])]),t._v(" "),a("h4",{attrs:{id:"统一组装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#统一组装"}},[t._v("#")]),t._v(" 统一组装")]),t._v(" "),a("p",[a("code",[t._v("Report.formatDatagram")]),t._v(" 数据报映射策略:")]),t._v(" "),a("ol",[a("li",[t._v("全局系统配置")]),t._v(" "),a("li",[t._v("传入的额外配置（一般包含当前触发的埋点信息）")]),t._v(" "),a("li",[t._v("占位")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("formatDatagram")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" extendsData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Obj "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据事件类型获取对应字段模板")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对模板中的内容进行映射")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("reportType")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("reduce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("temp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" val "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*    全局系统配置 */")]),t._v("\n                    extendsData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*      传入的额外配置 */")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'}'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*   占位 */")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" str "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("val"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" temp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'|'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("type=")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"中间件机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件机制"}},[t._v("#")]),t._v(" 中间件机制")]),t._v(" "),a("p",[t._v("宿主环境的各个事件上报的数据可能都不一样，有的需要记录时长，有的需要记录上一个事件的id"),a("br"),t._v("\n因此考虑到代码的可扩展性和可复用性，参考 redux 的中间件引入了 "),a("em",[a("strong",[t._v("中间件机制")])])]),t._v(" "),a("h4",{attrs:{id:"中间件配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件配置"}},[t._v("#")]),t._v(" 中间件配置")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[t._v("reportConfigs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Obj "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'appId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sysId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'openId'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loggerMiddleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("initMiddleware\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    click"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'eventId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'funcId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'preFuncId'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loggerMiddleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clickMiddleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("preFuncIdMiddleware\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"中间件运行机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#中间件运行机制"}},[t._v("#")]),t._v(" 中间件运行机制")]),t._v(" "),a("p",[t._v("固定格式：")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" someMiddleware "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Report 上下文 */")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" next "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 中间件链 */")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("opt "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 事件配置参数 */")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* side Effect !!! */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// before next middleware")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" reqData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* side Effect !!! */")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// after next middleware")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" reqData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("ul",[a("li",[t._v("中间件组合后将遵循洋葱模型")]),t._v(" "),a("li",[t._v("中间件返回值必须是 "),a("code",[t._v("next")]),t._v(" 执行结果")]),t._v(" "),a("li",[t._v("中间件中执行 "),a("code",[t._v("next")]),t._v(" 时需要将事件配置参数传入，将顺着中间件管道传入 "),a("code",[t._v("onTrigger")]),t._v(" ，因此最后一个中间件是最后一次包装事件配置参数的机会")])]),t._v(" "),a("p",[t._v("例如点击中间件 "),a("code",[t._v("clickMiddleware")]),t._v(" :")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("clickMiddleware")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("any")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Function")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("any")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("console")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'clickMiddleware'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" funcId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" _opt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" reqData "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("_opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        eventId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'click'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        isSysEvt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'N'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        funcId\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" reqData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h4",{attrs:{id:"绑定中间件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#绑定中间件"}},[t._v("#")]),t._v(" 绑定中间件")]),t._v(" "),a("p",[t._v("在数据上报模式初始化时为注册事件绑定中间件，将原 onTrigger 组合中间件，作为 triggerWithMiddlewares 绑定在对应事件配置上")]),t._v(" "),a("div",{staticClass:"language-ts extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ts"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("applyMiddlewares")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Report")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 原 onTrigger")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" originTrigger "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_onTrigger")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 映射，注入上下文")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// chains: Array<(next: Function) => (...opt: any[]) => Obj>")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" chains "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("middleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Function")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("middleware")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 剥离一层 chains 链，注入原 onTrigger")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compose")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("chains"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("originTrigger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onEnter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据事件上报配置，在这旮沓挨个注册数据上报中间件")]),t._v("\n    Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("keys")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reportConfigs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reportConfigs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("middlewares "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 包装原 onTrigger ，合并中间件")]),t._v("\n            config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("triggerWithMiddlewares "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("applyMiddlewares")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("middlewares"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"重写-ontrigger"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重写-ontrigger"}},[t._v("#")]),t._v(" 重写 onTrigger")]),t._v(" "),a("ol",[a("li",[t._v("此处重写的 onTrigger ，需要兼容外界的 push API，因此在此做参数合法校验")]),t._v(" "),a("li",[t._v("判断存在注册的中间件则调用，再将执行结果传入原onTrigger执行，否则直接调用 "),a("code",[t._v("this._onTrigger")])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onTrigger")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("reportOptList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" any"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" directive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("rest "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" reportOptList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 根据指令，抽取对应上报配置")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" sendConfig "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reportConfigs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("directive"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 拿到对应的中间件重构的 onTrigger")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" triggerWithMiddlewares "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sendConfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 若存在数据上报重构函数，使用重构的上报函数，否则直接调用 this._onTrigger")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" triggerWithMiddlewares "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("triggerWithMiddlewares")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("rest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_onTrigger")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"数据上报缓冲及边界处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据上报缓冲及边界处理"}},[t._v("#")]),t._v(" 数据上报缓冲及边界处理")]),t._v(" "),a("h4",{attrs:{id:"思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思路"}},[t._v("#")]),t._v(" 思路")]),t._v(" "),a("ul",[a("li",[t._v("sdk内部实现了一个简单的消息队列模型")]),t._v(" "),a("li",[t._v("上报模式 "),a("code",[t._v("onTrigger")]),t._v(" （生产者）将数据报组装完毕之后会将其添加进入消息队列，同时通知消费者当前有数据产生")]),t._v(" "),a("li",[t._v("此时消费者产生一个节流的消费任务，将缓冲时间内（可配置，默认2秒）的数据报全部上报")])]),t._v(" "),a("h3",{attrs:{id:"缓冲时间内的页面事件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓冲时间内的页面事件"}},[t._v("#")]),t._v(" 缓冲时间内的页面事件")]),t._v(" "),a("h4",{attrs:{id:"问题描述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述"}},[t._v("#")]),t._v(" 问题描述")]),t._v(" "),a("p",[t._v("在2秒缓冲时间内若产生以下宿主环境事件")]),t._v(" "),a("ul",[a("li",[t._v("路由跳转")]),t._v(" "),a("li",[t._v("宿主环境直接关闭")]),t._v(" "),a("li",[t._v("宿主环境退至后台休眠")])]),t._v(" "),a("p",[t._v("都将可能产生 "),a("strong",[t._v("数据丢失")]),t._v(" 或者 "),a("strong",[t._v("数据上报不及时")]),t._v(" 的问题")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("数据丢失")]),t._v(" - 宿主环境关闭，内存中消息队列的数据报直接清除掉")]),t._v(" "),a("li",[a("strong",[t._v("数据上报不及时")]),t._v(" - 宿主环境休眠，导致无法及时发送数据")])]),t._v(" "),a("p",[t._v("因此需要做宿主环境边界情况的处理")]),t._v(" "),a("h4",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("p",[t._v("设计消息队列模型向外提供"),a("strong",[t._v("卸载")]),t._v("与"),a("strong",[t._v("重载")]),t._v("的接口，分别在宿主环境状态改变时触发")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("卸载")]),t._v(" - "),a("code",[t._v("MsgsQueue.onUnload")]),t._v(" "),a("ul",[a("li",[t._v("触发：多页应用跳转、宿主环境直接关闭、宿主环境退至后台休眠")])]),t._v(" "),a("ol",[a("li",[t._v("立即注销当前节流的消费任务")]),t._v(" "),a("li",[t._v("尝试使用 "),a("code",[t._v("sendBeacon")]),t._v(" API，消费消息队列中的数据")]),t._v(" "),a("li",[t._v("消费成功，则退出")]),t._v(" "),a("li",[t._v("消费失败，则将消息队列中的数据分别在 "),a("code",[t._v("window.name")]),t._v(" 和 "),a("code",[t._v("localStorage")]),t._v(" 中做双缓存，同时使用相同的 key（带 chunk）做关联")]),t._v(" "),a("li",[t._v("在下次重载宿主环境时，比较缓存的 chunk ，重载消息队列")])])]),t._v(" "),a("li",[a("strong",[t._v("重载")]),t._v(" - "),a("code",[t._v("MsgsQueue.onLoad")]),t._v(" "),a("ul",[a("li",[t._v("触发：页面加载，宿主环境转至前台")])]),t._v(" "),a("ol",[a("li",[t._v("将 "),a("code",[t._v("window.name")]),t._v(" 和 "),a("code",[t._v("localStorage")]),t._v(" 缓存中的数据取出")]),t._v(" "),a("li",[t._v("合并去重，过滤出符合上报数据的缓存索引（ "),a("code",[t._v("report_temp_[chunk:6]")]),t._v(" ）")]),t._v(" "),a("li",[t._v("将得到的合法消息队列缓存，映射合并成消息队列可读的消息（双缓存格式不同，需 "),a("code",[t._v("JSON.parse")]),t._v("），重载消息队列")])])])]),t._v(" "),a("h4",{attrs:{id:"数据上报及时性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据上报及时性"}},[t._v("#")]),t._v(" 数据上报及时性")]),t._v(" "),a("p",[t._v("双缓存机制的目的："),a("strong",[t._v("增强数据上报的及时性")])]),t._v(" "),a("p",[t._v("使用 "),a("code",[t._v("window.name")]),t._v(" 和 "),a("code",[t._v("localStorage")]),t._v(" 双缓存机制，数据上报会产生以下情况")]),t._v(" "),a("ol",[a("li",[t._v("localStorage √ | window.name × ===> 上次访问该页面存在行为数据未处理，上报")]),t._v(" "),a("li",[t._v("localStorage × | window.name √ ===> 切至跨域网站，上报")]),t._v(" "),a("li",[t._v("localStorage √ | window.name √ ===> 切至同域网站，上报")])]),t._v(" "),a("p",[t._v("其中情况2，最开始处理方式是忽略掉，因为可能导致与情况1的数据重复"),a("br"),t._v("\n但是后端入库数据量太大无法去重"),a("br"),t._v("\n后来为保证数据上报的及时性，与后端协调查询的时候，查询时由前端处理去重")]),t._v(" "),a("h2",{attrs:{id:"精确停留时长记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#精确停留时长记录"}},[t._v("#")]),t._v(" 精确停留时长记录")]),t._v(" "),a("p",[t._v("记录客户在某个页面精确的停留时长，需要在合适时机记录 "),a("strong",[t._v("活跃节点")]),t._v(" 与 "),a("strong",[t._v("非活跃节点")])]),t._v(" "),a("ul",[a("li",[t._v("活跃事件\n"),a("ul",[a("li",[t._v("页面加载")]),t._v(" "),a("li",[t._v("页面切换")]),t._v(" "),a("li",[t._v("页面从后台切换至前台")])])]),t._v(" "),a("li",[t._v("非活跃事件\n"),a("ul",[a("li",[t._v("页面卸载")]),t._v(" "),a("li",[t._v("页面从前台切换至后台")])])])]),t._v(" "),a("p",[t._v("而且还需同时处理多页和单页的页面跳转")]),t._v(" "),a("h4",{attrs:{id:"思路-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思路-2"}},[t._v("#")]),t._v(" 思路")]),t._v(" "),a("p",[a("code",[t._v("PageTracer")]),t._v(" 组件为页面活跃节点提供 "),a("strong",[t._v("栈")]),t._v(" 数据结构用于保存，当触发活跃事件时入栈一条 "),a("strong",[t._v("活跃节点")]),t._v(" ，触发非活跃事件时入栈一条 "),a("strong",[t._v("非活跃节点")]),t._v(" ，另外提供接口用于计算当前活跃时长\n"),a("img",{attrs:{src:"/hx-analytics/img/%E9%A1%B5%E9%9D%A2%E6%B4%BB%E8%B7%83%E8%8A%82%E7%82%B9%E6%A0%88.jpeg",alt:"页面活跃节点栈"}}),t._v("\n活跃时长计算方式为栈内节点两两一组，用 "),a("strong",[t._v("非活跃节点")]),t._v(" 时间戳 - "),a("strong",[t._v("活跃节点")]),t._v(" ，再相加，即可得到总时长\n"),a("img",{attrs:{src:"/hx-analytics/img/%E5%81%9C%E7%95%99%E6%97%B6%E9%95%BF.jpeg",alt:"停留时长"}})]),t._v(" "),a("h3",{attrs:{id:"节点记录多次触发问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点记录多次触发问题"}},[t._v("#")]),t._v(" 节点记录多次触发问题")]),t._v(" "),a("h4",{attrs:{id:"问题描述-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述-2"}},[t._v("#")]),t._v(" 问题描述")]),t._v(" "),a("p",[t._v("正如上述的记录方案，停留时长计算要求的栈内数据是：")]),t._v(" "),a("ul",[a("li",[t._v("一条 "),a("strong",[t._v("活跃节点")]),t._v(" 一条非 "),a("strong",[t._v("非活跃节点")]),t._v("，重叠出现")]),t._v(" "),a("li",[t._v("栈底需要是 "),a("strong",[t._v("活跃节点")]),t._v("，栈顶需要是 "),a("strong",[t._v("非活跃节点")]),t._v("\n这是在一种较为理想的情况下的基本方案，稳定性是建立在设备触发 "),a("code",[t._v("visibilitychange")]),t._v(" 事件的正确性上的，然而在移动设备恶劣的环境下，免不了出现两条 "),a("strong",[t._v("活跃节点")]),t._v(" 连续入栈的情况（两条 "),a("strong",[t._v("非活跃节点")]),t._v(" 同理）")])]),t._v(" "),a("h4",{attrs:{id:"解决方案-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-2"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("p",[t._v("在记录 "),a("strong",[t._v("活跃节点")]),t._v(" 时（"),a("strong",[t._v("非活跃节点")]),t._v(" 同理），做一次栈顶数据校验，判断当前栈顶是 "),a("strong",[t._v("非活跃节点")]),t._v(" 才入栈，否则忽略"),a("br"),t._v("\n这样可以保证最终停留时长计算的正确性")]),t._v(" "),a("h3",{attrs:{id:"单页页面跳转问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单页页面跳转问题"}},[t._v("#")]),t._v(" 单页页面跳转问题")]),t._v(" "),a("h4",{attrs:{id:"问题描述-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述-3"}},[t._v("#")]),t._v(" 问题描述")]),t._v(" "),a("p",[t._v("现代单页应用基本使用 "),a("code",[t._v("hash")]),t._v(" 、 "),a("code",[t._v("history")]),t._v(" 的方式通过欺骗浏览器达到更改页面路由、视图，但是页面不重新刷新的目的，因此单纯的页面加载卸载等事件便不能完全监控页面的切换")]),t._v(" "),a("h4",{attrs:{id:"解决方案-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-3"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("p",[t._v("单页应用插件基本通过调用 "),a("code",[t._v("pushState")]),t._v(" 、"),a("code",[t._v("replaceState")]),t._v(" 原生API来触发 "),a("code",[t._v("history")]),t._v(" 状态的改变"),a("br"),t._v("\n通过类似于注册 "),a("a",{attrs:{href:"https://zh.wikipedia.org/wiki/%E7%8C%B4%E8%A1%A5%E4%B8%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("猴子补丁"),a("OutboundLink")],1),t._v(" 的方式，我们可以在运行时将这些浏览器API包装起来，在单页应用插件调用这些API的时候，向宿主环境抛出（dispatchEvent）一个自定义事件来通知sdk，这样便可以和处理页面加载卸载事件一样处理这些事件")]),t._v(" "),a("p",[t._v("一个可用的猴子补丁工具")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * 原生API派发浏览器事件猴子补丁\n * \n * @param {any} orig 要重写的原生API\n * @param {String} orig 派发的事件名称\n */")]),t._v("\n_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("nativeCodeEventPatch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("orig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 修改原生事件的行为，并返回用于覆盖")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 执行原生事件，缓存结果")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" res "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("orig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" arguments"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 初始化原生事件，注意将传入的事件名称转成小写")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" e "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Event")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("toLowerCase")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("assign")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" arguments "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 派发自定义事件")]),t._v("\n        window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchEvent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将原生事件执行结果返回，供单页应用插件处理")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("使用")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("history"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pushState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nativeCodeEventPatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("history"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pushState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pushState'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("history"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("replaceState "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nativeCodeEventPatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("history"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pushState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'replaceState'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("实际在使用的时候，可以将 "),a("code",[t._v("pushstate")]),t._v(" 、 "),a("code",[t._v("replacestate")]),t._v(" 、 "),a("code",[t._v("popstate")]),t._v(" 、 "),a("code",[t._v("hashchange")]),t._v(" 作为一类事件统一监控起来，这样可以统一单页应用不同的路由模式（hash mode, history mode），当然需在订阅的时候做过滤处理，当前若不符合页面切换条件（当前pathId与上一个路由pathId相同）的应过滤掉")]),t._v(" "),a("h3",{attrs:{id:"移动设备数据丢失问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#移动设备数据丢失问题"}},[t._v("#")]),t._v(" 移动设备数据丢失问题")]),t._v(" "),a("h4",{attrs:{id:"问题描述-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题描述-4"}},[t._v("#")]),t._v(" 问题描述")]),t._v(" "),a("p",[t._v("移动设备如果直接从后台删掉应用，将导致此次访问的停留时长数据丢失")]),t._v(" "),a("h4",{attrs:{id:"解决方案-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-4"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("ul",[a("li",[t._v("在每次应用退至后台时，"),a("u",[t._v("记录一次停留时长数据，组装标准的上报数据包，直接"),a("strong",[t._v("缓存在本地缓存")])]),t._v("，并记录缓存的chunk")]),t._v(" "),a("li",[t._v("若应用切至前台时，查看当前是否存在上次停留时长数据的缓存，若存在则清空")]),t._v(" "),a("li",[t._v("若应用未切至前台（直接从后台删掉应用），则"),a("u",[t._v("本次访问停留时长为"),a("strong",[t._v("应用刚刚切至后台时的保存在本地缓存的数据")]),t._v("，并且将在下次访问该页面时上报")])]),t._v(" "),a("li",[t._v("注：iOS微信浏览器上 "),a("code",[t._v("visibilitychange")]),t._v(" 事件存在问题，前后台切换时不会触发，因此停留时长会同时记录切至后台的时间")])]),t._v(" "),a("p",[t._v("以这样的方式能够基本规避数据丢失问题")]),t._v(" "),a("h2",{attrs:{id:"埋点高亮圈选机制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#埋点高亮圈选机制"}},[t._v("#")]),t._v(" 埋点高亮圈选机制")]),t._v(" "),a("p",[t._v("使用canvas，通过监控配置人员鼠标移动给当前鼠标停留位置上最顶层的dom设置蒙板，形成高亮效果")]),t._v(" "),a("h4",{attrs:{id:"整体流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#整体流程"}},[t._v("#")]),t._v(" 整体流程")]),t._v(" "),a("ol",[a("li",[t._v("父层推送指令至sdk，切换当前模式为埋点配置模式")]),t._v(" "),a("li",[t._v("sdk开启埋点配置模式\n"),a("ul",[a("li",[t._v("开启canvas蒙板（DomMasker），并查询当前页面已设置过得埋点信息，作为 "),a("strong",[t._v("预设埋点")])]),t._v(" "),a("li",[t._v("监控鼠标移动（mousemove）")]),t._v(" "),a("li",[t._v("获取鼠标悬停位置最顶层的dom元素，计算宽高并与 "),a("strong",[t._v("预设埋点")]),t._v(" 一同绘制到canvas上")])])]),t._v(" "),a("li",[t._v("当鼠标点击某个高亮的蒙板，sdk将选中埋点推送指令至父层，同时设置当前埋点配置模式静默状态（此时依然是埋点配置模式，只是不监控鼠标移动、鼠标点击，只监控父层消息推送）")]),t._v(" "),a("li",[t._v("至此便完成了一次埋点圈选过程，父层可以通过给sdk推送重置消息重新开启流程")])]),t._v(" "),a("h3",{attrs:{id:"双缓存机制解决蒙板闪烁问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#双缓存机制解决蒙板闪烁问题"}},[t._v("#")]),t._v(" 双缓存机制解决蒙板闪烁问题")]),t._v(" "),a("h4",{attrs:{id:"遇到问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#遇到问题"}},[t._v("#")]),t._v(" 遇到问题")]),t._v(" "),a("p",[t._v("鼠标移动，需要 "),a("code",[t._v("clearRect")]),t._v(" 清空画布，先重新绘制 "),a("strong",[t._v("预设埋点")]),t._v(" ，再绘制当前鼠标悬停位置dom高亮的区域"),a("br"),t._v("\n但是这个过程中一旦重新绘制 "),a("strong",[t._v("预设埋点")]),t._v(" 的时间较长，将会存在画布闪烁问题"),a("br"),t._v("\n比如当前一屏画面中 "),a("strong",[t._v("预设埋点")]),t._v(" 有十个，若在重置画布的时候循环的一个个 "),a("code",[t._v("fillRect")]),t._v(" ，等待绘制的时间将很长，从而导致闪烁问题"),a("br"),t._v("\n然而在一次圈选流程中 "),a("strong",[t._v("预设埋点")]),t._v(" 是不会变的，因此重新绘制不但会出现闪烁问题，而且从逻辑角度讲也不应该")]),t._v(" "),a("h4",{attrs:{id:"解决思路"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决思路"}},[t._v("#")]),t._v(" 解决思路")]),t._v(" "),a("p",[t._v("将 "),a("strong",[t._v("预设埋点")]),t._v(" 从网络请求过来之后映射成埋点信息，首先在内存中初始化另外一个canvas，将 "),a("strong",[t._v("预设埋点")]),t._v(" 绘制上去作为内存缓冲，在每次鼠标移动需要重新绘制高亮区域的时候，重载内存缓冲canvas，相当于多个 "),a("strong",[t._v("预设埋点")]),t._v(" 只通过一次绘制图形操作即可绘制完毕，从而消除蒙板闪烁问题")])])}),[],!1,null,null,null);s.default=e.exports}}]);